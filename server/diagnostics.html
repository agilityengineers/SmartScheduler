<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email System Diagnostics</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: #333;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    h2 {
      margin-top: 30px;
      color: #444;
    }
    .card {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .section {
      margin-bottom: 30px;
    }
    .status {
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
    }
    .status-success {
      background-color: #d4edda;
      color: #155724;
    }
    .status-warning {
      background-color: #fff3cd;
      color: #856404;
    }
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
    }
    pre {
      background: #f1f1f1;
      padding: 10px;
      border-radius: 4px;
      overflow: auto;
    }
    .test-form {
      margin-top: 20px;
    }
    input, button {
      padding: 8px 12px;
      margin: 5px 0;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background: #45a049;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 10px;
      vertical-align: middle;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hidden {
      display: none;
    }
    .results {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Email System Diagnostics</h1>
    
    <div class="section">
      <h2>Email Configuration</h2>
      <div class="card" id="email-config"></div>
    </div>
    
    <div class="section">
      <h2>SMTP Connectivity Test</h2>
      <div class="card" id="smtp-test">
        <button id="test-smtp">Test SMTP Connection</button>
        <div class="loader" id="smtp-loader"></div>
        <div id="smtp-results" class="results"></div>
      </div>
    </div>
    
    <div class="section">
      <h2>SendGrid API Test</h2>
      <div class="card" id="sendgrid-test">
        <button id="test-sendgrid">Test SendGrid API</button>
        <div class="loader" id="sendgrid-loader"></div>
        <div id="sendgrid-results" class="results"></div>
      </div>
    </div>
    
    <div class="section">
      <h2>Network Connectivity Test</h2>
      <div class="card" id="network-test">
        <button id="test-network">Test Network Connectivity</button>
        <div class="loader" id="network-loader"></div>
        <div id="network-results" class="results"></div>
      </div>
    </div>
    
    <div class="section">
      <h2>Send Test Email</h2>
      <div class="card">
        <div class="test-form">
          <div>
            <label for="test-email">Email Address:</label>
            <input type="email" id="test-email" placeholder="Enter email address">
          </div>
          <button id="send-test">Send Test Email</button>
          <div class="loader" id="email-loader"></div>
        </div>
        <div id="email-results" class="results"></div>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Fetch email configuration on page load
      fetch('/api/email/diagnostics/config')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const config = data.data;
            let html = '<h3>Current Configuration</h3>';
            
            const fromEmailStatus = config.fromEmailValid 
              ? '<span class="status status-success">Valid</span>'
              : '<span class="status status-error">Invalid</span>';
              
            const smtpStatus = config.smtpConfigured 
              ? '<span class="status status-success">Configured</span>'
              : '<span class="status status-error">Not Configured</span>';
              
            const sendgridStatus = config.sendgridConfigured 
              ? '<span class="status status-success">Configured</span>'
              : '<span class="status status-error">Not Configured</span>';
              
            html += `
              <p><strong>Environment:</strong> ${config.environment}</p>
              <p><strong>FROM_EMAIL:</strong> ${config.fromEmail} ${fromEmailStatus}</p>
              <p><strong>Normalized FROM_EMAIL:</strong> ${config.normalizedFromEmail}</p>
              <p><strong>SMTP:</strong> ${smtpStatus}</p>
              <p><strong>SendGrid:</strong> ${sendgridStatus}</p>
              <p><strong>Primary Delivery Method:</strong> ${config.primaryMethod}</p>
              <p><strong>Backup Delivery Method:</strong> ${config.backupMethod}</p>
            `;
            
            document.getElementById('email-config').innerHTML = html;
          } else {
            document.getElementById('email-config').innerHTML = `
              <p class="status status-error">Error loading configuration: ${data.message}</p>
            `;
          }
        })
        .catch(error => {
          document.getElementById('email-config').innerHTML = `
            <p class="status status-error">Error: ${error.message}</p>
          `;
        });
      
      // Test SMTP Connection
      document.getElementById('test-smtp').addEventListener('click', function() {
        const loader = document.getElementById('smtp-loader');
        const results = document.getElementById('smtp-results');
        
        loader.style.display = 'inline-block';
        results.innerHTML = 'Testing SMTP connection...';
        
        fetch('/api/email/diagnostics/smtp')
          .then(response => response.json())
          .then(data => {
            loader.style.display = 'none';
            
            if (data.success) {
              results.innerHTML = `
                <p class="status status-success">SMTP Connection Successful</p>
                <pre>${JSON.stringify(data.data, null, 2)}</pre>
              `;
            } else {
              results.innerHTML = `
                <p class="status status-error">SMTP Connection Failed</p>
                <p>${data.message}</p>
                <pre>${JSON.stringify(data.details || {}, null, 2)}</pre>
              `;
            }
          })
          .catch(error => {
            loader.style.display = 'none';
            results.innerHTML = `
              <p class="status status-error">Error: ${error.message}</p>
            `;
          });
      });
      
      // Test SendGrid API
      document.getElementById('test-sendgrid').addEventListener('click', function() {
        const loader = document.getElementById('sendgrid-loader');
        const results = document.getElementById('sendgrid-results');
        
        loader.style.display = 'inline-block';
        results.innerHTML = 'Testing SendGrid API...';
        
        fetch('/api/email/diagnostics/sendgrid')
          .then(response => response.json())
          .then(data => {
            loader.style.display = 'none';
            
            if (data.success) {
              const hasMailSend = data.data.hasMailSendPermission 
                ? '<span class="status status-success">Yes</span>'
                : '<span class="status status-error">No</span>';
                
              const accountActive = data.data.accountActive 
                ? '<span class="status status-success">Active</span>'
                : '<span class="status status-error">Inactive</span>';
                
              results.innerHTML = `
                <p class="status status-success">SendGrid API Connection Successful</p>
                <p><strong>Account Status:</strong> ${accountActive}</p>
                <p><strong>Has mail.send Permission:</strong> ${hasMailSend}</p>
                <p><strong>Permissions:</strong></p>
                <pre>${JSON.stringify(data.data.permissions, null, 2)}</pre>
              `;
            } else {
              results.innerHTML = `
                <p class="status status-error">SendGrid API Connection Failed</p>
                <p>${data.message}</p>
              `;
            }
          })
          .catch(error => {
            loader.style.display = 'none';
            results.innerHTML = `
              <p class="status status-error">Error: ${error.message}</p>
            `;
          });
      });
      
      // Test Network Connectivity
      document.getElementById('test-network').addEventListener('click', function() {
        const loader = document.getElementById('network-loader');
        const results = document.getElementById('network-results');
        
        loader.style.display = 'inline-block';
        results.innerHTML = 'Testing network connectivity...';
        
        fetch('/api/email/diagnostics/network')
          .then(response => response.json())
          .then(data => {
            loader.style.display = 'none';
            
            if (data.success) {
              let html = '<p class="status status-success">Network Tests Completed</p>';
              
              data.data.forEach(test => {
                const status = test.success 
                  ? '<span class="status status-success">Success</span>'
                  : '<span class="status status-error">Failed</span>';
                  
                html += `
                  <div style="margin-top: 15px;">
                    <p><strong>${test.name}:</strong> ${status}</p>
                    <p><strong>Host:</strong> ${test.host}</p>
                    <p><strong>Port:</strong> ${test.port}</p>
                    <p><strong>Response Time:</strong> ${test.responseTime || 'N/A'}ms</p>
                    ${test.error ? `<p><strong>Error:</strong> ${test.error}</p>` : ''}
                  </div>
                `;
              });
              
              results.innerHTML = html;
            } else {
              results.innerHTML = `
                <p class="status status-error">Network Tests Failed</p>
                <p>${data.message}</p>
              `;
            }
          })
          .catch(error => {
            loader.style.display = 'none';
            results.innerHTML = `
              <p class="status status-error">Error: ${error.message}</p>
            `;
          });
      });
      
      // Send Test Email
      document.getElementById('send-test').addEventListener('click', function() {
        const email = document.getElementById('test-email').value;
        const loader = document.getElementById('email-loader');
        const results = document.getElementById('email-results');
        
        if (!email) {
          results.innerHTML = `
            <p class="status status-warning">Please enter an email address</p>
          `;
          return;
        }
        
        loader.style.display = 'inline-block';
        results.innerHTML = `Sending test email to ${email}...`;
        
        fetch('/api/email/diagnostics/test', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email })
        })
          .then(response => response.json())
          .then(data => {
            loader.style.display = 'none';
            
            if (data.success) {
              results.innerHTML = `
                <p class="status status-success">Test Email Sent Successfully</p>
                <p><strong>Recipient:</strong> ${email}</p>
                <p><strong>Delivery Method:</strong> ${data.method}</p>
                <p><strong>Message ID:</strong> ${data.messageId || 'N/A'}</p>
                <p>Please check your inbox (and spam folder) for the test email.</p>
              `;
            } else {
              results.innerHTML = `
                <p class="status status-error">Failed to Send Test Email</p>
                <p>${data.message}</p>
                <pre>${JSON.stringify(data.details || {}, null, 2)}</pre>
              `;
            }
          })
          .catch(error => {
            loader.style.display = 'none';
            results.innerHTML = `
              <p class="status status-error">Error: ${error.message}</p>
            `;
          });
      });
    });
  </script>
</body>
</html>